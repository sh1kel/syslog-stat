# syslog сервер для postfix

### задачи
* логирование писем с адреса payment@mail.youdo.com в отдельный файл.
* аггрегация статистики по задержкам при отправлении писем с разделением по доменам.

### принципы работы
Приложение служает порт UDP 127.0.0.1:5141 и принимает сообщения syslog в формате RFC5424.
 
Логи обрабатываются конвеерно, каждый этап конвеера реализован в виде отдельного потока.

Письма payment отправляются в системный syslog в категорию LOCAL4.*.

Подсчет ~~средней задержки~~ 90 перцентиля от задержки вычисляется из поля delay лога postfix. 
При запросе значения задержки, оно обнуляется для запрашиваемого домена, 
поэтому можно получать статистику за различные промежутки времени.

Что бы не жрать много памяти, при достижении количества метрик задержки в 200к на домен,
старые 100к удаляются.

Так же раз в 5 минут отрабатывает чистильщик очереди и удаляет "зависшие" письма, которые висят там больше 10 минут.
Это всякие мусорные сессии, которые никуда не отправились, но память жрут.

### api
* ```http://localhost:8081/stat``` 
выводит текущее количество писем в очереди и количество обработанных syslog писем
* ```http://localhost:8081/domains```
выводит список доменов, по которым есть статистика
* ``` http://localhost:8081/delays/domain.tld```
выводит ~~среднюю задержку~~ 90 перцентиль отправки для домена domain.tld **И** удаляет метрики для этого домена
